---
title: "CO2SYS"
author: "Jose Martinez"
date: "2023-03-23"
output: html_document
---

```{r}
###############
# Can we quantify ocean acidification in the subtropical North Atlantic Ocean?
#1) Is surface ocean pCo2 increasing?
#2) is surface ocean seawater pH decreasing?
#3) Is surface ocean seawater saturation state with respect to aragonite decreasing?

# Intro > Methods > Results > Discussion mini-lab report 
###############
```

### Load required libraries

```{r setup, include=FALSE}
library(prettydoc)
library(tidyverse)
library(seacarb)
library(gsw)
library(readr)
library(plotly)
library(performance)
library(readr)
#

```




```{r}


bats_bottle <- read_delim("bats_bottle.txt", 
    delim = "\t", escape_double = FALSE, 
    col_names = FALSE, trim_ws = TRUE, skip = 60)
# import column names from BATS and assign to Data
colnames(bats_bottle) = colnames(read_csv("bats_bottle.txt", 
    skip = 59))
#View(bats_bottle)

```
## Variable Names

yyyymmdd = Year Month Day   
decy   = Decimal Year     
time   = Time (hhmm)      
latN   = Latitude (Deg N) 
lonW   = Longitude (Deg W)
Depth  = Depth (m)                  
Temp   = Temperature ITS-90 (C)    
CTD_S  = CTD Salinity (PSS-78)      
Sal1   = Salinity-1 (PSS-78)        
Sig-th = Sigma-Theta (kg/m^3)       
O2(1)  = Oxygen-1 (umol/kg)          
OxFixT = Oxygen Fix Temp (C)        
Anom1  = Oxy Anomaly-1 (umol/kg)    
CO2    = dissolved inorganic carbon (umol/kg)              
Alk    = Alkalinity (uequiv)        
NO31   = Nitrate+Nitrite-1 (umol/kg)
NO21   = Nitrite-1 (umol/kg)        
PO41   = Phosphate-1 (umol/kg)      
Si1    = Silicate-1 (umol/kg)       
POC    = POC (ug/kg)                
PON    = PON (ug/kg)                
TOC    = TOC (umol/kg)                
TN     = TN (umol/kg)  
Bact   = Bacteria enumeration (cells*10^8/kg)   
POP    = POP (umol/kg)
TDP    = Total dissolved Phosphorus (nmol/kg)
SRP    = Low-level phosphorus (nmol/kg)
BSi    = Particulate biogenic silica (umol/kg)
LSi    = Particulate lithogenic silica  (umol/kg)
Pro    = Prochlorococcus (cells/ml)
Syn    = Synechococcus (cells/ml)
Piceu  = Picoeukaryotes (cells/ml)
Naneu  = Nanoeukaryotes (cells/ml)

Quality flags
-999 = Missing or bad data
   0 = Less than detection limit

```{r}
# Calculate CO2SYS parameters
#carb(flag, var1, var2, S=35, T=25, Patm=1, P=0, Pt=0, Sit=0,
 #       k1k2="x", kf="x", ks="d", pHscale="T", b="u74", gas="potential", 
  #      warn="y", eos="eos80", long=1.e20, lat=1.e20)
#we have TA and DI, S, T, Pt, Sit, but no pressure
bats_co2 = bats_bottle %>% 
  mutate(P_gsw = gsw_p_from_z(Depth*-1,latN))
# now we have all the necessary variables to calculate the surface seawater chemistry parameters but be careful with our units

# We now have TA, DIC, S, T, Pt, Sit, and Pressure
# what are the units of these and what does CO2SYS need?

#DIC umol/kg we need mol/kg
# DIC*10^-6

#TA is in uequiv, which is essentially (umol/kg) we need mol/kg

# Alk*10^-6

#S is in PSS and we will EOS80 (PSS)

# Sal1
#T is in degrees C and we need degrees

# Temp

#Sit is in umol/kg, we need mol/kg

# Si1*10^-6

#Pt is in umol/kg we need mol/kg

# PO41*10^-6

#P_gsw is in dbar and we need bar

# P_gsw*10^-1

# We will need to converrt units scaling with CO2SYS

```

```{r}
bats_co2sys =
  bats_co2 %>% 
  filter(Alk!=-999,CO2!=-999,Sal1!=-999,Temp!=-999,P_gsw!=-999,PO41!=-999,Si1!=-999,lonW!=-999,latN!=-999) %>% 
  rename(TotalC=CO2) %>% 
  mutate(carb(flag =15, var1 = Alk*10^-6, var2 = TotalC*10^-6, 
                 S= Sal1, 
                 T= Temp, 
                 Patm=1, 
                 P=P_gsw*10^-1, 
                 Pt=PO41*10^-6,
                 Sit=Si1*10^-6,
                 k1k2="l", kf="pf", ks="d", pHscale="T", b="u74", gas="potential", 
                 warn="y", eos="eos80", long=360-lonW, lat=latN))

bats_co2sys_surf =
  bats_co2sys %>% 
  filter(Depth < 100) %>% 
  filter(pCO2insitu > 200) # BATS told me this point was bad so I am not going to include it


bats_co2sys_surf %>% 
  ggplot()+
  geom_point(aes(x=decy,y=pCO2insitu), color = 'black')+
  geom_line(aes(x=decy,y=pCO2insitu),color ='red')+
  geom_smooth(aes(x=decy, y=pCO2insitu,method = "lm"),color='blue')+
  xlab('Time')+
  scale_x_continuous(limits = c(1991,2022), expand = c(0,0),breaks = seq(1990,2025,5))+
  labs(y=expression(pCO[2]*" (µatm)"))+
  #ggtitle('PCO2 Time Series (1988-2021)')+
  labs(title=expression(pCO[2]*' BATS Time Series (1991-2021)'))+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(color="black"),
        axis.text.y = element_text(size = 13),
        axis.text.x = element_text(size = 13),
        #axis.title.y = element_text(vjust = 3, size = 12),
        #axis.title.x = element_text(hjust = 0.45,vjust =-1, size = 12),
        legend.position= "none",
        plot.title = element_text(hjust = 0.5, size = 15))

pCO2_time = lm(pCO2insitu~decy,data =  bats_co2sys_surf) # y (Sig) is a function of x(decy), lm(y~x,data = data )
summary(pCO2_time)
            
#view(test)

# For HW:

# Make decy vs Pco2 plot pretty
# Include methods text for CO2sys in lab report


# For thursday:
# How do we check our model performance?
# HOw do we plot our model predictions?
```

Methods:

Using Co2sys in R:

We first adjust all the parameters units measured in BATS by switching them from umol/kg to mol/kg in DIC,TA,Silicate,and Phosphate by multiplying by 10^-6. We also took depth from BATS bottle and got equivalent dbar pressure values needed by co2sys and also converted the units from dbar to bar by multiplying by 10^-1. Temperature and salinity could be used as measured and collected in the bats bottle data. We then inputted all the data once changed if needed into co2sys.By using mutate and piping we created a new dataframe with the prior data and resultant pCO2,carbonate ions,pH, and saturation state from co2sys.

DIC umol/kg we need mol/kg
# DIC*10^-6

#TA is in uequiv, which is essentially (umol/kg) we need mol/kg

# Alk*10^-6

#S is in PSS and we will EOS80 (PSS)

# Sal1
#T is in degrees C and we need degrees

# Temp

#Sit is in umol/kg, we need mol/kg

# Si1*10^-6

#Pt is in umol/kg we need mol/kg

# PO41*10^-6

#P_gsw is in dbar and we need bar

# P_gsw*10^-1


```{r}
# Checking model performance
#install.packages('performance')
#install.packages('see')
#library(see)
library(performance)
check_model(pCO2_time) # Model assumptions appear valid
summary(pCO2_time) #pvalue same as anova
anova(pCO2_time) #pvalue is same as summary

bats_co2sys_surf_pred = 

  bats_co2sys_surf %>% 
  mutate(predict(pCO2_time, interval ='prediction', level=0.95))
# the base R way with cbind and do not need to rename outputs
bats_co2sys_surf_pred = 
cbind(bats_co2sys_surf, predict(pCO2_time, interval ='prediction', level =0.95))

bats_co2sys_surf_pred %>% 
  filter(decy>2000) %>% 
  ggplot()+
  geom_point(mapping = aes(x=decy,y=pCO2insitu))+
  geom_line(aes(x=decy,y=fit),color ='red',size = 1.5)+
  geom_ribbon(aes(x=decy,ymin = lwr,ymax = upr),alpha = 0.2,fill = 'purple')+
  xlab('Time')+
  scale_x_continuous(limits = c(2000,2022), expand = c(0,0),breaks = seq(2000,2025,5))+
  labs(y=expression(pCO[2]*" (µatm)"))+
  #ggtitle('PCO2 Time Series (1988-2021)')+
  labs(title=expression(pCO[2]*' BATS Time Series (2000-2021)'))+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(color="black"),
        axis.text.y = element_text(size = 13),
        axis.text.x = element_text(size = 13),
        #axis.title.y = element_text(vjust = 3, size = 12),
        #axis.title.x = element_text(hjust = 0.45,vjust =-1, size = 12),
        legend.position= "none",
        plot.title = element_text(hjust = 0.5, size = 15))
```

## Is surface pCo2 increasing?

There is a seasonal cycle in the surface ocean pCo2 at BATS with higher pCo2 observed in late summer to early fall and lower pCo2 observed in late winter and early spring. There is a detectable and consistent (Anova  p< 0.001) annual increase in pCo2 by 1.85 +-0.07 uatm/yr. 
Also show plot with model. The figure caption describes plot (points = data, line = model, shaded region = 95% confidence intervals.)

The rest of the HW is due thursay !